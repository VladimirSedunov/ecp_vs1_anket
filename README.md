# ecp_vs1_anket

<h1 align="center">Проект по тестированию процесса получения и обработки поступающих сообщений в Систему персонифицированного учета (СПУ) из ГИС ЕЦП (Анкетная часть ВС1)</h1>
<hr>

## Проект реализован с использованием
Python = Pytest = Allure Report = Jenkins = Telegram = Java = IBM WAS = PosgreSQL = DB2 for z/OS

![](/design/icons/Python.png)&emsp;![](/design/icons/Pytest.png)&emsp;
![](/design/icons/Allure_Report.png)&emsp;![](/design/icons/Jenkins.png)&emsp;![](/design/icons/Telegram.png)&emsp;![](/design/icons/Java.png)&emsp;
![ ](/design/icons/was.png)&emsp;![ ](/design/icons/Postgresql.png)&emsp;![ ](/design/icons/db2.png)
<hr>

## Основной шаблон выполнения шагов тест-кейса:
* Подготовка Базы Данных (удаление сведений по ИЛС, записей о ЕЦП, задач в очереди на выполнение)
* Чтение файла JSON с анкетой и получение из него параметров теста
* Выполнение SQL-запроса INSERT для заполнения соответствующей таблицы ЕЦП
* Выполнение SQL-запроса INSERT для помещения задачи в очередь на выполнение
* Ожидание выполнения задачи подсистемой
* Проверка значений набора полей заданных таблиц
* Создание отчёта о расхождениях между ожидаемым и фактическим результатом
<hr>
 
## Фрагмент КП для ручного тестирования.
Тест-кейсов очень много, из них отобраны 103 теста для автоматизации.
![](/design/images/КП.PNG)
<hr>

## Файл КП для автотестов:
* /data/ФНС_отчетность/КП автотест ФНС.xlsx

<hr>

## Как реализованы проверки в автотестах

Проверки в автотестах осуществляются после каждой укладки реестра. Обычно в тесте есть одна такая проверка, но возможно любое количество таких проверок.

Проверка представляет из себя сверку результатов выполнения заданных SQL-скриптов с контрольными (далее - Эталонами).
Контрольные результаты находятся в КП на Листах с соответствующими названиями.
Например, название Листа "T4TC2_404_1" означает, что здесь находятся Эталоны для теста T4TC2 (сам тест называется test_T4TC2), 404 - условный номер Альбома форматов (т.е. схем XSD), 1 - номер по порядку проверки в тесте.

Содержимое Листа представляет собой набор таблиц следующего содержания:
* Левая верхняя ячейка - уникальный код SQL-запроса
* Справа оn неё - сам SQL-запрос
* Ниже запроса находится строка с перечнем полей таблицы/таблиц базы данных, получаемых при запросе
* Ещё ниже - строки с ожидаемыми (контрольными) результатами SQL-запроса
 
![](/design/images/Эталон.png)

Тип проверки значения в каждой ячейки задаётся её цветом. В этом проекте используются цвета:
* Желтый -	проверяется точное совпадение значений в ячейке и соответствующего значения в выборке, получаемой в результате работы теста.
* ТемноКрасный -	текущая дата или текущий TimeStamp. Разрешается отклонение от текущего времени сервера на несколько минут.
* Фиолетовый -	максимальная дата (9999-12-31) или максимальный TimeStamp (23:59:59 9999-12-31 23:59:59)
* Голубой	- проверка осуществляется особым образом, контрольные значения задаются в тесте, либо формируются в POST-запросах.
* НетЗаливки	- проверка значения не проводится

Кроме того, в отчёте используется Розовый цвет для окраски ячеек с фактическими результатами теста, с расхождениями относительно Эталона.

Таблица цветов находится на Листе "Легенда" и считывается в процессе тестирования.
![](/design/images/Легенда.png)

Таблица соответствия SQL-запросов и их уникальных кодов находится на Листе "Эталон_Скрипты" и считывается в процессе тестирования.
![](/design/images/Эталон_Скрипты.png)

Тип проверки задаётся таблицей "Раскраска" на Листе "Легенда" и считывается в процессе тестирования.

Для каждого SQL-запроса через указание его уникального кода задаются цвета, в которые раскрашиваются ячейки Эталонов.
![](/design/images/Раскраска.png)

**В процессе тестирования** на этапе сверки последовательно выполняются SQL-запросы из таблицы "Эталон_Скрипты". Для каждой полученной таким образом выборки
выполняется сверка значений с Эталонными таблицами в соответствии с цветом ячеек и формируется файл Отчёта, который представляет собой набор Листов, каждый из которых
содержит набор эталонных таблиц и следующих за каждой из них таблицы с фактической выборкой:

![](/design/images/REPORT_T3TC1_4010.png)

Расхождения реальных значений и эталонных выделены розовым цветом.

Кроме того, Лист, предшествующий Листу с таблицами, называется "Лог_1" ("Лог_2" и т.д.) и содержит сводную информацию о расхождениях:

![](/design/images/Лог_1.png)

Если расхождений нет, этот Лист выглядит так:

![](/design/images/Лог_2.PNG)
<hr>

## Формирование Эталонов

Автотестирование может быть выполнено в режиме создания Эталонов.
В этом случае по результатам работы выбранного набора тестов формируются Листы с выборками по SQL-запросам, ячейки автоматически раскрашиваются в соответствии с таблицей "Раскраска",
Листы компонуются в один файл Excel.

Тестировщику остаётся проверить выборки и заменить Листы в файле КП.
<hr>

## Запуск автотестов выполняется на сервере Jenkins

Командная строка:

pytest ${SELECT_TESTS} ${SUMMARY_DIFF_LOG} --bd_name=${bd_name}

### Параметры сборки

* SELECT_TESTS - Параметр определяет выбранную группу тестов.
* bd_name - База данных (тестовый стенд)
* SUMMARY_DIFF_LOG - Параметр задаёт необходимость прикрепления к Allure-отчёту итоговой информации о расхождениях

![](/design/images/jenkins1.png)

### 5. Результат запуска сборки можно посмотреть в отчёте Allure Report

![](/design/images/jenkins2.png)

<hr>

## Настроено автоматическое оповещение о результатах сборки Jenkins в Telegram-бот

![](/design/images/telegram_bot.PNG)

<hr>

## Примечание:

Проект не может быть выложен на публичный ресурс по соображениям конфиденциальности.

